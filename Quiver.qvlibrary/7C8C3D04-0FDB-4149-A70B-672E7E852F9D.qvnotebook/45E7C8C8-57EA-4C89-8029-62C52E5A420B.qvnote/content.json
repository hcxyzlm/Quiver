{
  "title": "ipa内购流程优化",
  "cells": [
    {
      "type": "markdown",
      "data": "## 优化点\n1. 优化购买流程\n2. 使用新的api获取购买凭证\n3. 优化跟服务器的二次验证时机\n\n## 原来支付购买流程\n1. 获取产品信息\n2. 用户选择某个产品，跟后台通信创建懒人服务器订单订单\n3. 程序向App Store发送支付请求\n4. App Store处理支付请求并返回苹果支付订单完成信息，并从ios系统队列删除苹果支付订单\n5. 程序从获取购买凭证，并发送至服务器\n6. 服务器将数据发给App Store来验证该交易的有效性，服务器读取返回的数据，确定用户购买的内容\n5. 服务器发放购买道具\n\n## 现在的支付购买流程\n流程图所下图所示\n![13.png](quiver-image-url/5B6E52D4886DBA14A2FD4610329CAAD0.png)\n1. 获取产品信息\n2. 用户选择某个产品\n3. 程序向App Store发送支付请求\n4. App Store处理支付请求并返回苹果支付订单信息，并进入二次校验状态\n5. 程序从获取购买凭证，并发送至服务器\n6. 服务器将数据发给App Store来验证该苹果支付订单的有效性，服务器读取返回的数据，确定用户购买的内容\n7. 后台创建懒人服务器订单\n8. 服务器发放购买道具\n9. 服务器将购买的内容传递给程序，ios系统队列finish苹果支付订单，购买成功\n\n## <font color=#ee0000 size=6 face=\"黑体\">开会讨论疑问点记录</font>\n\n### 1.ios客户端后台服务器二次校验失败重试时机\n  目前有三种，1.重新启动app 2. 每次按下Home再次返回app界面 3. 用户重新购买产品\n### 2.服务器跟苹果服务器校验的返回订单列表中，除了处理当前订单外，其他历史的订单如何处理\n  后台处理当前交易的订单外，支付成功过的订单处理需要判断订单的交易时间(这一版上线的时间为基准点)，来决定是否发放道具。\n### 3. 如何遍历查找当前的订单\n  二次校验的接口，发送当前支付的苹果订单号，后台需要遍历苹果服务器校验返回的所有支付订单，找到正在支付的苹果订单并做相应的逻辑业务\n  json数据格式见下图\n### 4. 二次校验的接口修改\n1. 新增一个字段，作为苹果当前支付订单号，后台需要增加一个状态码，用于区分是成功购买还是恢复购买的信息提示\n\n## 后台的工作\n1. 接收ios端发过来的苹果支付订单购买凭证。\n2. 判断凭证是否已经存在或验证过，然后存储该凭证\n3. 将该凭证发送到苹果的服务器验证，并将验证结果返回给客户端。\n4. 验证成功苹果支付订单，并查询没有该苹果支付订单没有验证过，后台创建懒人服务器订单 \n5. 如果需要，修改用户相应的会员权限。\n\n## 苹果服务器二次校验的josn数据说明\n###apple文档\n[apple支付说明文档](https://developer.apple.com/library/content/releasenotes/General/ValidateAppStoreReceipt/Introduction.html#//apple_ref/doc/uid/TP40010573-CH105-SW1 \"title\")\n\n  由于使用新的api获取购买凭证，与旧的购买凭证返回josn数据不一致，旧的购买凭证只有一个唯一对应的订单，新的api购买凭证返回的json，会包含没有从ios系统队列没有finish苹果支付订单。如图所示:\n![12.png](quiver-image-url/A7120F5EC6AEE273F21BAE457B447AAF.png)\n\n### 状态码 描述\n21000 App Store无法读取你提供的JSON数据\n21002 收据数据不符合格式\n21003 收据无法被验证\n21004 你提供的共享密钥和账户的共享密钥不一致\n21005 收据服务器当前不可用\n21006 收据是有效的，但订阅服务已经过期。当收到这个信息时，解码后的收据信息也包含在返回内容中\n21007 收据信息是测试用（sandbox），但却被发送到产品环境中验证\n21008 收据信息是产品环境中使用，但却被发送到测试环境中验证\n\n### 服务器二次校验处理:\n1. 由ios客户端发送正在支付的苹果订单id和购买凭证给后台，后台需要遍历苹果服务器校验返回的所有支付订单，找到正在支付的苹果订单并做相应的逻辑业务\n\n## 服务器处理方案\n1. 服务器二次校验，是只对当前苹果支付支付的订单发放道具，还是所有包括未完成但是已经扣款的苹果支付订单发放道具？\n2. 如果是对所有苹果支付订单发放道具，需要后台根据苹果订单的时间来决定是否发放道具，服务器已经验证过的苹果订单直接返回成功给客户端，不再对改订单发放道具\n\n## 遇到的坑\n1. 没有从ios系统队列finish苹果订单，会在下一次启动app自动恢复购买流程\n2. 没有finish的苹果支付订单，再次点击购买回会恢复购买\n3. 苹果扣款会在二次校验之前完成\n\n"
    },
    {
      "type": "text",
      "data": ""
    }
  ]
}